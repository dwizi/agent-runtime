# syntax=docker/dockerfile:1.7

FROM oven/bun:1.3.9 AS qmd-sidecar
WORKDIR /app

RUN apt-get update && \
    apt-get install -y --no-install-recommends ca-certificates git && \
    rm -rf /var/lib/apt/lists/* && \
    bun install -g github:tobi/qmd && \
    for d in /root/.bun/install/global/node_modules/sqlite-vec-linux-*; do \
      if [ -f "$d/vec0.so" ] && [ ! -e "$d/vec0.so.so" ]; then \
        ln -s vec0.so "$d/vec0.so.so"; \
      fi; \
    done && \
    qmd --help >/dev/null

COPY ops/qmd-sidecar/server.ts /app/server.ts

EXPOSE 8091
CMD ["bun", "/app/server.ts"]
