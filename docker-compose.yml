services:
  agent-runtime:
    platform: ${AGENT_RUNTIME_IMAGE_PLATFORM:-linux/amd64}
    build:
      context: .
      dockerfile: Dockerfile
    container_name: agent-runtime-app
    restart: unless-stopped
    environment:
      AGENT_RUNTIME_ENV: ${AGENT_RUNTIME_ENV:-production}
      AGENT_RUNTIME_HTTP_ADDR: :8080
      AGENT_RUNTIME_DATA_DIR: /data
      AGENT_RUNTIME_WORKSPACE_ROOT: /data/workspaces
      AGENT_RUNTIME_DB_PATH: /data/agent-runtime/meta.sqlite
      AGENT_RUNTIME_QMD_SIDECAR_URL: ${AGENT_RUNTIME_QMD_SIDECAR_URL:-http://agent-runtime-qmd:8091}
      AGENT_RUNTIME_QMD_SHARED_MODELS_DIR: /data/qmd-models
      AGENT_RUNTIME_QMD_EMBED_EXCLUDE_GLOBS: ${AGENT_RUNTIME_QMD_EMBED_EXCLUDE_GLOBS:-logs/chats/**}
      AGENT_RUNTIME_QMD_AUTO_EMBED: ${AGENT_RUNTIME_QMD_AUTO_EMBED:-true}
      AGENT_RUNTIME_OBJECTIVE_POLL_SECONDS: ${AGENT_RUNTIME_OBJECTIVE_POLL_SECONDS:-15}
      AGENT_RUNTIME_DEFAULT_CONCURRENCY: ${AGENT_RUNTIME_DEFAULT_CONCURRENCY:-5}
      AGENT_RUNTIME_EXT_PLUGINS_CONFIG: ${AGENT_RUNTIME_EXT_PLUGINS_CONFIG:-ext/plugins/plugins.json}
      AGENT_RUNTIME_EXT_PLUGIN_CACHE_DIR: ${AGENT_RUNTIME_EXT_PLUGIN_CACHE_DIR:-/data/agent-runtime/ext-plugin-cache}
      AGENT_RUNTIME_EXT_PLUGIN_WARM_ON_BOOTSTRAP: ${AGENT_RUNTIME_EXT_PLUGIN_WARM_ON_BOOTSTRAP:-true}
      AGENT_RUNTIME_TINYFISH_API_KEY: ${AGENT_RUNTIME_TINYFISH_API_KEY:-}
      AGENT_RUNTIME_TINYFISH_BASE_URL: ${AGENT_RUNTIME_TINYFISH_BASE_URL:-https://agent.tinyfish.ai}
      AGENT_RUNTIME_RESEND_API_KEY: ${AGENT_RUNTIME_RESEND_API_KEY:-}
      AGENT_RUNTIME_RESEND_FROM: ${AGENT_RUNTIME_RESEND_FROM:-}
      AGENT_RUNTIME_RESEND_API_BASE: ${AGENT_RUNTIME_RESEND_API_BASE:-https://api.resend.com}
      AGENT_RUNTIME_HEARTBEAT_ENABLED: ${AGENT_RUNTIME_HEARTBEAT_ENABLED:-true}
      AGENT_RUNTIME_HEARTBEAT_INTERVAL_SECONDS: ${AGENT_RUNTIME_HEARTBEAT_INTERVAL_SECONDS:-30}
      AGENT_RUNTIME_HEARTBEAT_STALE_SECONDS: ${AGENT_RUNTIME_HEARTBEAT_STALE_SECONDS:-120}
      AGENT_RUNTIME_HEARTBEAT_NOTIFY_ADMIN: ${AGENT_RUNTIME_HEARTBEAT_NOTIFY_ADMIN:-true}
      AGENT_RUNTIME_TRIAGE_ENABLED: ${AGENT_RUNTIME_TRIAGE_ENABLED:-true}
      AGENT_RUNTIME_TRIAGE_NOTIFY_ADMIN: ${AGENT_RUNTIME_TRIAGE_NOTIFY_ADMIN:-true}
      AGENT_RUNTIME_TASK_NOTIFY_POLICY: ${AGENT_RUNTIME_TASK_NOTIFY_POLICY:-both}
      AGENT_RUNTIME_TASK_NOTIFY_SUCCESS_POLICY: ${AGENT_RUNTIME_TASK_NOTIFY_SUCCESS_POLICY:-}
      AGENT_RUNTIME_TASK_NOTIFY_FAILURE_POLICY: ${AGENT_RUNTIME_TASK_NOTIFY_FAILURE_POLICY:-}
      AGENT_RUNTIME_SANDBOX_ENABLED: ${AGENT_RUNTIME_SANDBOX_ENABLED:-true}
      AGENT_RUNTIME_SANDBOX_ALLOWED_COMMANDS: ${AGENT_RUNTIME_SANDBOX_ALLOWED_COMMANDS:-echo,cat,ls,curl,grep,rg,head,tail,python3,chromium,sh,bash,apk,pip,pip3,git,jq,sed,awk,find,mkdir,rm,cp,mv,touch,chmod,unzip,tar,gzip,wc,sort,uniq,tee,date,sleep,whoami,pwd,ps,top,kill,node,npm,npx,bun,bunx}
      AGENT_RUNTIME_SANDBOX_RUNNER_COMMAND: ${AGENT_RUNTIME_SANDBOX_RUNNER_COMMAND:-}
      AGENT_RUNTIME_SANDBOX_RUNNER_ARGS: ${AGENT_RUNTIME_SANDBOX_RUNNER_ARGS:-}
      AGENT_RUNTIME_SANDBOX_TIMEOUT_SECONDS: ${AGENT_RUNTIME_SANDBOX_TIMEOUT_SECONDS:-20}
      AGENT_RUNTIME_SOUL_GLOBAL_FILE: ${AGENT_RUNTIME_SOUL_GLOBAL_FILE:-/context/SOUL.md}
      AGENT_RUNTIME_SOUL_WORKSPACE_REL_PATH: ${AGENT_RUNTIME_SOUL_WORKSPACE_REL_PATH:-context/SOUL.md}
      AGENT_RUNTIME_SOUL_CONTEXT_REL_PATH: ${AGENT_RUNTIME_SOUL_CONTEXT_REL_PATH:-context/agents/{context_id}/SOUL.md}
      AGENT_RUNTIME_SYSTEM_PROMPT_GLOBAL_FILE: ${AGENT_RUNTIME_SYSTEM_PROMPT_GLOBAL_FILE:-/context/SYSTEM_PROMPT.md}
      AGENT_RUNTIME_SYSTEM_PROMPT_WORKSPACE_REL_PATH: ${AGENT_RUNTIME_SYSTEM_PROMPT_WORKSPACE_REL_PATH:-context/SYSTEM_PROMPT.md}
      AGENT_RUNTIME_SYSTEM_PROMPT_CONTEXT_REL_PATH: ${AGENT_RUNTIME_SYSTEM_PROMPT_CONTEXT_REL_PATH:-context/agents/{context_id}/SYSTEM_PROMPT.md}
      AGENT_RUNTIME_DISCORD_TOKEN: ${AGENT_RUNTIME_DISCORD_TOKEN:-}
      AGENT_RUNTIME_TELEGRAM_TOKEN: ${AGENT_RUNTIME_TELEGRAM_TOKEN:-}
      AGENT_RUNTIME_CODEX_PUBLISH_URL: ${AGENT_RUNTIME_CODEX_PUBLISH_URL:-}
      AGENT_RUNTIME_CODEX_PUBLISH_BEARER_TOKEN: ${AGENT_RUNTIME_CODEX_PUBLISH_BEARER_TOKEN:-}
      AGENT_RUNTIME_CODEX_PUBLISH_TIMEOUT_SECONDS: ${AGENT_RUNTIME_CODEX_PUBLISH_TIMEOUT_SECONDS:-8}
      AGENT_RUNTIME_LLM_PROVIDER: ${AGENT_RUNTIME_LLM_PROVIDER:-openai}
      AGENT_RUNTIME_LLM_BASE_URL: ${AGENT_RUNTIME_LLM_BASE_URL:-https://api.openai.com/v1}
      AGENT_RUNTIME_LLM_API_KEY: ${AGENT_RUNTIME_LLM_API_KEY:-}
      AGENT_RUNTIME_LLM_MODEL: ${AGENT_RUNTIME_LLM_MODEL:-gpt-4o}
      AGENT_RUNTIME_LLM_TIMEOUT_SECONDS: ${AGENT_RUNTIME_LLM_TIMEOUT_SECONDS:-60}
      PUBLIC_HOST: ${PUBLIC_HOST:-localhost}
      ADMIN_HOST: ${ADMIN_HOST:-admin.localhost}
      AGENT_RUNTIME_ADMIN_HTTP_TIMEOUT_SECONDS: ${AGENT_RUNTIME_ADMIN_HTTP_TIMEOUT_SECONDS:-120}
    volumes:
      - ./data:/data
      - ./context:/context
    expose:
      - "8080"
    networks:
      - agent_runtime_net
    depends_on:
      - qmd-sidecar

  qmd-sidecar:
    platform: ${AGENT_RUNTIME_QMD_IMAGE_PLATFORM:-linux/amd64}
    build:
      context: .
      dockerfile: Dockerfile.qmd-sidecar
    container_name: agent-runtime-qmd
    restart: unless-stopped
    environment:
      AGENT_RUNTIME_ENV: ${AGENT_RUNTIME_ENV:-production}
      AGENT_RUNTIME_WORKSPACE_ROOT: /data/workspaces
      AGENT_RUNTIME_QMD_BINARY: ${AGENT_RUNTIME_QMD_BINARY:-qmd}
      AGENT_RUNTIME_QMD_SIDECAR_ADDR: ${AGENT_RUNTIME_QMD_SIDECAR_ADDR:-:8091}
      AGENT_RUNTIME_QMD_INDEX: ${AGENT_RUNTIME_QMD_INDEX:-agent-runtime}
      AGENT_RUNTIME_QMD_SHARED_MODELS_DIR: /data/qmd-models
      AGENT_RUNTIME_QMD_INDEX_TIMEOUT_SECONDS: ${AGENT_RUNTIME_QMD_INDEX_TIMEOUT_SECONDS:-180}
      AGENT_RUNTIME_QMD_QUERY_TIMEOUT_SECONDS: ${AGENT_RUNTIME_QMD_QUERY_TIMEOUT_SECONDS:-30}
    volumes:
      - ./data:/data
    networks:
      - agent_runtime_net

  caddy:
    image: caddy:2.8-alpine
    container_name: agent-runtime-caddy
    restart: unless-stopped
    depends_on:
      - agent-runtime
    environment:
      PUBLIC_HOST: ${PUBLIC_HOST:-localhost}
      ADMIN_HOST: ${ADMIN_HOST:-admin.localhost}
      ACME_EMAIL: ${ACME_EMAIL:-}
    command:
      - /bin/sh
      - -c
      - command -v openssl >/dev/null 2>&1 || apk add --no-cache openssl >/dev/null; /etc/caddy/scripts/gen-mtls.sh && caddy run --config /etc/caddy/Caddyfile --adapter caddyfile
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./ops/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./ops/caddy/scripts:/etc/caddy/scripts:ro
      - ./ops/caddy/pki:/etc/caddy/pki
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - agent_runtime_net

volumes:
  caddy_data:
  caddy_config:

networks:
  agent_runtime_net:
    driver: bridge
